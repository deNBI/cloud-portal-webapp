<div *ngIf="isLoaded && userinfo?.PublicKey == 'None'">
    <div>
        <div class="card">
            <div class="card-header">
                <i class="fa fa-align-justify"></i> Public Key
            </div>

            <div class="card-body">

                <div style="padding:5px" class="alert alert-info"><strong>Info: </strong>
                    You need to set a valid SSH Key before you can start a machine. Please set a
                    valid key below or on
                    your <a
                            href="#/userinfo">personal data page</a>.
                </div>
                <div style="width: 100%" class="table-responsive">
                    <table class="table table-striped">

                        <tr app-public-key [userinfo]="userinfo"></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div *ngIf=" isLoaded==false" class="loader"></div>
<div *ngIf=" isLoaded && userinfo?.PublicKey != 'None' && projects.length == 0">
    <div class="alert alert-warning" role="alert">
        You are not a member of any Simple VM project.
    </div>
</div>
<div *ngIf=" isLoaded && userinfo?.PublicKey != 'None' && projects.length > 0">

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <strong>New Virtual Machine</strong>
                    â€“ Form
                </div>

                <div class="card-body">

                    <form id="application_form" #f="ngForm"
                          class="form-horizontal">
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label"><strong>Project*</strong></label>

                            <div class="col-md-6">

                                <select required class="form-control" name="selectedProject"
                                        [(ngModel)]="selectedProject"
                                        (ngModelChange)="getSelectedProjectClient();"
                                        [ngClass]="{'is-invalid':f.controls.selectedProject?.invalid && (f.controls.selectedProject?.dirty || f.controls.selectedProject.touched),
                             'is-valid':f.controls.selectedProject?.valid && (f.controls.selectedProject?.dirty || f.controls.selectedProject?.touched)}">
                                    <option value="undefined" disabled selected hidden> Please
                                        Select
                                    </option>
                                    <option *ngFor="let project of projects" [ngValue]="project">
                                        {{project[0]}}
                                    </option>

                                </select>


                            </div>

                        </div>
                        <div *ngIf="client_avaiable">
                            <div class="form-group row"
                                 *ngIf="(selectedProjectVmsMax || selectedProjectVmsMax == 0) && selectedProject && selectedProject[1] != FREEMIUM_ID">
                                <label class="col-md-3 form-control-label"><strong>Vms in
                                    use</strong></label>
                                <div class="col-md-6">
                                    <strong> current: {{selectedProjectVmsUsed}} | max:
                                        {{selectedProjectVmsMax}}
                                        Vms</strong>
                                </div>
                            </div>
                            <div class="alert alert-warning" role="alert" *ngIf="selectedProjectVmsUsed >= selectedProjectVmsMax">
                                The limit for virtual machines has been reached for this project.
                                Your principal investigator can request more
                                resources if necessary

                            </div>

                            <div *ngIf="selectedProjectVmsUsed < selectedProjectVmsMax">
                                <div *ngIf="selectedProject" class="form-group row">
                                    <label class="col-md-3 form-control-label"><strong>Name*</strong></label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input required id="id_instance_name" name="instance_name"
                                                   class="form-control"
                                                   type="text" placeholder="Instancename" ngModel
                                                   [ngClass]="{'is-invalid':f.controls.instance_name?.invalid && (f.controls.instance_name?.dirty || f.controls.instance_name?.touched),
                             'is-valid':f.controls.instance_name?.valid && (f.controls.instance_name?.dirty || f.controls.instance_name?.touched)}">
                                        </div>
                                        <div style="color: dodgerblue">Info: The instance name will also
                                            be the hostname of the vm.
                                        </div>
                                    </div>
                                </div>

                                <div *ngIf="selectedProject" class="form-group row">
                                    <label class="col-md-3 form-control-label"><strong>Flavor*</strong></label>
                                    <div class="col-md-6">


                                        <select required class="form-control col-md-6"
                                                name="selectedFlavor"
                                                [(ngModel)]="selectedFlavor"
                                                [ngClass]="{'is-invalid':f.controls.selectedFlavor?.invalid && (f.controls.selectedFlavor?.dirty || f.controls.selectedFlavor?.touched),
                             'is-valid':f.controls.selectedFlavor?.valid && (f.controls.selectedFlavor?.dirty || f.controls.selectedFlavor?.touched)}">
                                            <option value="undefined" disabled selected hidden> Please
                                                Select
                                            </option>
                                            <option *ngFor="  let flavor of flavors" [ngValue]="flavor">
                                                {{flavor.name}}
                                            </option>


                                        </select>

                                    </div>

                                    <button *ngIf="selectedFlavor"
                                            (click)="collapsed2=!collapsed2; toggleInformationButton2()"
                                            class="btn btn-info .btn-pill">
                                        {{informationButton2}}
                                    </button>

                                </div>

                                <div class="col-md-9">
                                    <app-flavor-detail [collapse2]="collapsed2"
                                                       [flavor]="selectedFlavor"></app-flavor-detail>
                                </div>

                                <div *ngIf="selectedProject" class="form-group row">
                                    <label class="col-md-3 form-control-label"><strong>Image*</strong></label>


                                    <div class="col-md-6">

                                        <select required class="form-control" name="selectedImage"
                                                [(ngModel)]="selectedImage"
                                                [ngClass]="{'is-invalid':f.controls.selectedImage?.invalid && (f.controls.selectedImage?.dirty || f.controls.selectedImage.touched),
                             'is-valid':f.controls.selectedImage?.valid && (f.controls.selectedImage?.dirty || f.controls.selectedImage?.touched)}">
                                            <option value="undefined" disabled selected hidden> Please
                                                Select
                                            </option>

                                            <option *ngFor="let image of images" [ngValue]="image">
                                                {{image.name}}
                                            </option>

                                        </select>


                                    </div>
                                    <button *ngIf="selectedImage"
                                            (click)="collapsed1=!collapsed1; toggleInformationButton()"
                                            class="btn btn-info .btn-pill">
                                        {{informationButton}}
                                    </button>
                                </div>
                                <div class="col-md-9">
                                    <app-image-detail [collapse1]="collapsed1"
                                                      [image]="selectedImage"></app-image-detail>
                                </div>


                                <div *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID"
                                     class="form-group row">

                                    <label class="col-md-3 form-control-label"><strong>Optional
                                        parameters</strong></label>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-info .btn-pill"
                                                (click)="optional_params= !optional_params">
                                            <strong *ngIf="!optional_params">Show</strong><strong
                                                *ngIf="optional_params">Hide</strong>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params"
                                 class="form-group row">

                                <label class="col-md-3 form-control-label">Storage volumes</label>

                                <div class="col-md-9">
                                    <strong>current: {{selectedProjectVolumesUsed}} | max:
                                        {{selectedProjectVolumesMax}}
                                        Volumes
                                    </strong>
                                </div>
                                <div class="alert alert-warning col-md-9" role="alert"
                                     *ngIf="selectedProjectVolumesUsed >= selectedProjectVolumesMax">
                                    The limit for volumes has been reached for this project.
                                    Your principal investigator can request more
                                    resources if necessary

                                </div>


                            </div>

                            <div *ngIf="selectedProjectVolumesUsed < selectedProjectVolumesMax">
                                <div class="form-group row"
                                     *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params">
                                    <label *ngIf="diskspace <= 0" class="col-md-3 form-control-label">Volumename</label>
                                    <label *ngIf="diskspace > 0"
                                           class="col-md-3 form-control-label"><strong>Volumename*</strong></label>

                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <input type="text" placeholder="Volumename"
                                                   [value]="volumeName"
                                                   (input)="volumeName = $event.target.value"
                                                   [ngClass]="{'is-invalid':diskspace > 0 && volumeName == '',
                             'is-valid': diskspace == 0 || (diskspace > 0 && volumeName != '')}">

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params"
                                 class="form-group row">

                                <label class="col-md-3 form-control-label">Storage</label>

                                <div class="col-md-9">
                                    <div class="input-group">
                                        <input min="0" step="1" [value]="diskspace"
                                               (input)="diskspace = $event.target.value"
                                               type="number"
                                               placeholder="e.g 8 ">
                                        <div class="input-group-append"><span
                                                class="input-group-text"> GB
                                    </span></div>

                                            <div class="col-md-6">
                                                <strong>current: {{selectedProjectDiskspaceUsed}} | max
                                                    {{selectedProjectDiskspaceMax}}
                                                    GB</strong>
                                            </div>

                                        </div>
                                    </div>


                                </div>
                            </div>

                            <button *ngIf="projectDataLoaded" type="button"
                                    [disabled]="f.invalid || (diskspace > 0 && volumeName == '')"
                                    class="btn btn-primary offset-md-8"
                                    data-toggle="modal"
                                    (click)="startVM(selectedFlavor.name,selectedImage.name,f.controls.instance_name.value,selectedProject[0],selectedProject[1],diskspace);resetData();resetProgressBar;infoModal.show();">
                                Start VM
                            </button>
                            <br><br><br>


                    </form>
                    <div class="alert alert-danger"
                         *ngIf="isLoaded && !client_avaiable && selectedProject && client_checked">The
                        corresponding client is currently offline.
                        If you have any questions please contact cloud@denbi.de.
                    </div>


                </div>

                <!--/.col-->

            </div>
        </div>
        <div class="col-md-6">

        </div>

    </div>
</div>


<div bsModal #infoModal="bs-modal" class="modal fade " tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-info" role="document"
         [ngClass]="newVm?.status =='ACTIVE' ? 'modal-lg':''">

        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Status</h4>
                <button type="button" class="close" style="cursor: pointer"
                        (click)="infoModal.hide()"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body"
                 *ngIf="(newVm?.status == 'BUILD' || newVm?.status == 'PORT_CLOSED' || newVm ==null) && !create_error?.error ">
                <p>We are setting up a machine for you. This can take up to 5 minutes.</p>

                <div class="progress">
                    <div class="progress-bar progress-bar-striped {{creating_vm_prograss_bar}} bg-info"
                         role="progressbar" style="width: 33%;"
                         aria-valuemin="0"
                         aria-valuemax="100">{{creating_vm_status}}
                    </div>

                    <div class="progress-bar progress-bar-striped {{checking_vm_status_progress_bar}}"
                         [style.width.%]="checking_vm_status_width"
                         role="progressbar"
                         aria-valuemin="0"
                         aria-valuemax="100">{{checking_vm_status}}
                    </div>

                    <div
                            class="progress-bar progress-bar-striped bg-success progress-bar-animated "
                            role="progressbar"
                            [style.width.%]="checking_vm_ssh_port_width"

                            aria-valuemin="0"
                            aria-valuemax="100">{{checking_vm_ssh_port}}
                    </div>
                </div>
                <p>If you close this modal you can find instructions how to connect to the virtual
                    machine on the
                    instance overview site</p>
            </div>
            <div class="modal-body" *ngIf="newVm?.status == 'ACTIVE'">
                <pre><code>{{newVm?.ssh_command}}</code></pre>
            </div>
            <div class="modal-body" *ngIf="create_error?.error">
                An Error occured.<br><br>
                <pre><code>{{create_error.error}}</code></pre>
            </div>
            <div class="modal-footer">
                <button *ngIf="newVm?.status == 'ACTIVE'"
                        routerLinkActive="active"
                        [routerLink]="['/virtualmachines/vmOverview']"
                        type="button" class="btn btn-info nav-link"
                        (click)="infoModal.hide();resetData()">Instance Overview
                </button>
                <button type="button" class="btn btn-secondary"
                        (click)="infoModal.hide();resetData()">Close
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


