<div *ngIf="isLoaded && userinfo?.PublicKey == 'None'">
  <div>
    <div class="card">
      <div class="card-header">
        <i class="fa fa-align-justify"></i> Public Key
      </div>

      <div class="card-body">

        <div style="padding:5px" class="alert alert-info"><strong>Info: </strong>
          You need to set a valid SSH Key before you can start a machine. Please set a
          valid key below or on
          your <a
            href="#/userinfo">personal data page</a>.
        </div>
        <div style="width: 100%" class="table-responsive">
          <table class="table table-striped">

            <tr app-public-key [userinfo]="userinfo"></tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf=" isLoaded==false" class="loader"></div>
<div *ngIf=" isLoaded && userinfo?.PublicKey != 'None' && projects.length == 0">
  <div class="alert alert-warning" role="alert">
    You are not a member of any Simple VM project.
  </div>
</div>
<div *ngIf=" isLoaded && userinfo?.PublicKey != 'None' && projects.length > 0">

  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <strong>New Virtual Machine</strong>
          – Form
        </div>

        <div class="card-body">

          <form id="application_form" #f="ngForm"
                class="form-horizontal">
            <div class="form-group row">
              <label class="col-md-2 form-control-label"><strong>Project*</strong></label>
              <span *ngIf="client_avaiable && !projectDataLoaded" class="spinner-border text-info"></span>


              <div class="col-md-6">


                <select required class="form-control" name="selectedProject"
                        [(ngModel)]="selectedProject"
                        (ngModelChange)="getSelectedProjectClient();"
                >
                  <option value="undefined" disabled selected hidden> Please
                    Select
                  </option>
                  <option *ngFor="let project of projects" [ngValue]="project">
                    {{project[0]}}
                  </option>

                </select>


              </div>

            </div>
            <div *ngIf="client_avaiable && projectDataLoaded">
              <div class="form-group row"
                   *ngIf="selectedProject[1] != FREEMIUM_ID">
                <label class="col-md-2 form-control-label"><strong>Overview</strong></label>


                <div class="row text-center col-md 6">

                  <div class="col-sm-12 col-md">
                    <div class="text-muted">Vms</div>
                    <strong>{{selectedProjectVmsUsed}} |
                      {{selectedProjectVmsMax}}</strong>
                    <div style="background-color: darkgray;" class="progress progress-xs mt-2"

                    >
                      <div class="progress-bar " role="progressbar"
                           [ngStyle]="{'width.%': selectedProjectVmsUsed/selectedProjectVmsMax *100}"
                           [ngClass]=" {'bg-success':(selectedProjectVmsUsed / selectedProjectVmsMax) < 0.5 ,
                         'bg-warning':(selectedProjectVmsUsed / selectedProjectVmsMax) > 0.5 &&   selectedProjectVmsUsed < selectedProjectVmsMax,
                         'bg-danger': selectedProjectVmsUsed === selectedProjectVmsMax}"

                           aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>


                  <div class="col-sm-12 col-md">
                    <div class="text-muted">Ram [GB]</div>
                    <strong> {{selectedProjectRamUsed}} | {{selectedProjectRamMax}}</strong>
                    <div style="background-color: darkgray;" class="progress progress-xs mt-2">
                      <div class="progress-bar " role="progressbar"
                           [ngStyle]="{'width.%': selectedProjectRamUsed/selectedProjectRamMax *100 }" aria-valuenow="0"
                           [ngClass]=" {'bg-success':(selectedProjectRamUsed / selectedProjectRamMax) < 0.5 ,
                         'bg-warning':(selectedProjectRamUsed / selectedProjectRamMax) > 0.5 &&   selectedProjectRamUsed < selectedProjectRamMax,
                         'bg-danger': selectedProjectRamUsed === selectedProjectRamMax}"
                           aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>

                  <div class="col-sm-12 col-md ">
                    <div class="text-muted">Cores</div>
                    <strong> {{selectedProjectCoresUsed}} | {{selectedProjectCoresMax}}</strong>
                    <div style="background-color: darkgray;" class="progress progress-xs mt-2">
                      <div class="progress-bar " role="progressbar"
                           [ngStyle]="{'width.%': selectedProjectCoresUsed/selectedProjectCoresMax *100 }"
                           [ngClass]=" {'bg-success':(selectedProjectCoresUsed / selectedProjectCoresMax) < 0.5 ,
                         'bg-warning':(selectedProjectCoresUsed / selectedProjectCoresMax) > 0.5 &&   selectedProjectCoresUsed < selectedProjectCoresMax,
                         'bg-danger': selectedProjectCoresUsed === selectedProjectCoresMax}"
                           aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>

                  <div class="col-sm-12 col-md ">
                    <div class="text-muted">Storage Volumes</div>
                    <strong> {{selectedProjectVolumesUsed}} | {{selectedProjectVolumesMax}}</strong>
                    <div style="background-color: darkgray;" class="progress progress-xs mt-2">
                      <div class="progress-bar" role="progressbar"
                           [ngStyle]="{'width.%': selectedProjectVolumesUsed/selectedProjectVolumesMax *100 }"
                           [ngClass]=" {'bg-success':(selectedProjectVolumesUsed / selectedProjectVolumesMax) < 0.5 ,
                         'bg-warning':(selectedProjectVolumesUsed / selectedProjectVolumesMax) > 0.5 &&   selectedProjectVolumesUsed < selectedProjectVolumesMax,
                         'bg-danger': selectedProjectVolumesUsed === selectedProjectVolumesMax}"
                           aria-valuenow="0"
                           aria-valuenow="60"
                           aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>

                  <div class="col-sm-12 col-md ">
                    <div class="text-muted">Volumes Storage [GB]</div>
                    <strong> {{selectedProjectDiskspaceUsed}} | {{selectedProjectDiskspaceMax}}</strong>
                    <div style="background-color: darkgray;" class="progress progress-xs mt-2">
                      <div class="progress-bar" role="progressbar"
                           [ngStyle]="{'width.%': selectedProjectDiskspaceUsed/selectedProjectDiskspaceMax *100 }"
                           [ngClass]=" {'bg-success':(selectedProjectDiskspaceUsed / selectedProjectDiskspaceMax) < 0.5 ,
                         'bg-warning':(selectedProjectDiskspaceUsed / selectedProjectDiskspaceMax) > 0.5 &&   selectedProjectDiskspaceUsed < selectedProjectDiskspaceMax,
                         'bg-danger': selectedProjectDiskspaceUsed === selectedProjectDiskspaceMax}"

                           aria-valuemin="0" aria-valuemax="[selectedProjectDiskspaceMax]"></div>
                    </div>
                  </div>

                  <div class="col-sm-12 col-md ">
                    <div class="text-muted">GPUs</div>
                    <strong> {{selectedProjectGPUsUsed}} | {{selectedProjectGPUsMax}}</strong>
                    <div style="background-color: darkgray;" class="progress progress-xs mt-2">
                      <div class="progress-bar" role="progressbar"
                           [ngStyle]="{'width.%': selectedProjectGPUsUsed/selectedProjectGPUsMax *100 }"
                           [ngClass]=" {'bg-success':(selectedProjectGPUsUsed / selectedProjectGPUsMax) < 0.5 ,
                         'bg-warning':(selectedProjectGPUsUsed / selectedProjectGPUsMax) > 0.5 &&   selectedProjectGPUsUsed < selectedProjectGPUsMax,
                         'bg-danger': selectedProjectGPUsUsed === selectedProjectGPUsMax}"

                           aria-valuemin="0" aria-valuemax="[selectedProjectGPUsMax]"></div>
                    </div>
                  </div>


                </div>
              </div>
              <div class="alert alert-warning" role="alert"
                   *ngIf="selectedProject && selectedProjectVmsUsed >= selectedProjectVmsMax">
                The limit for virtual machines has been reached for this project.
                Your principal investigator can request more
                resources if necessary.

              </div>
              <div class="alert alert-warning" role="alert"
                   *ngIf="selectedProject && selectedProjectVmsUsed < selectedProjectVmsMax && flavors_loaded && flavors.length == 0 && !selectedFlavor">
                There are too few cores and not enough ram available for this project to start a new machine.
                Your principal investigator can request more
                resources if necessary.
              </div>


              <div *ngIf="selectedProjectVmsUsed < selectedProjectVmsMax && (flavors?.length > 0 || selectedFlavor)">
                <div *ngIf="selectedProject" class="form-group row">
                  <label class="col-md-2 form-control-label"><strong>Name*</strong></label>
                  <div class="col-md-6">
                    <div class="input-group">
                      <input required id="id_instance_name" name="instance_name"
                             class="form-control"
                             type="text" placeholder="Instancename" ngModel
                             [ngClass]="{'is-invalid':f.controls.instance_name?.invalid && (f.controls.instance_name?.dirty || f.controls.instance_name?.touched),
                             'is-valid':f.controls.instance_name?.valid && (f.controls.instance_name?.dirty || f.controls.instance_name?.touched)}">
                    </div>
                    <div style="color: dodgerblue">Info: The instance name will also
                      be the hostname of the vm.
                    </div>
                  </div>
                </div>

                <div *ngIf="selectedProject" class="form-group row">
                  <label class="col-md-2 form-control-label"><strong>Flavor*</strong></label>
                  <div class="col-md-10">


                    <app-flavor-detail [selectedFlavor]="selectedFlavor"
                                       [flavors]="flavors"
                                       (selectedFlavorChange)="selectedFlavor=$event"></app-flavor-detail>

                  </div>


                </div>


                <div *ngIf="selectedProject" class="form-group row">
                  <label class="col-md-2 form-control-label"><strong>Image*</strong></label>
                  <div class="col-md-10">


                    <app-image-detail [selectedImage]="selectedImage"
                                      [images]="images"
                                      (selectedImageChange)="selectedImage=$event"></app-image-detail>
                  </div>
                </div>


                <div *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID"
                     class="form-group row">

                  <label class="col-md-2 form-control-label"><strong>Optional
                    parameters</strong></label>
                  <div class="col-md-6">
                    <button type="button" class="btn btn-info .btn-pill"
                            (click)="optional_params= !optional_params">
                      <strong *ngIf="!optional_params">Show</strong><strong
                      *ngIf="optional_params">Hide</strong>
                    </button>
                  </div>
                </div>
              </div>

              <div
                *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params && selectedProjectVmsUsed < selectedProjectVmsMax"
                class="form-group row">

                <div class="alert alert-warning col-md-9" role="alert"
                     *ngIf="selectedProjectVolumesUsed >= selectedProjectVolumesMax">
                  The limit for volumes has been reached for this project.
                  Your principal investigator can request more
                  resources if necessary

                </div>


              </div>

              <div
                *ngIf="selectedProjectVolumesUsed < selectedProjectVolumesMax && optional_params && selectedProjectVmsUsed < selectedProjectVmsMax">
                <div class="form-group row"
                     *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params">
                  <label *ngIf="diskspace <= 0" class="col-md-2 form-control-label">Volumename</label>
                  <label *ngIf="diskspace > 0"
                         class="col-md-2 form-control-label"><strong>Volumename*</strong></label>

                  <div class="col-md-9">
                    <div class="input-group">
                      <input type="text" placeholder="Volumename"
                             [value]="volumeName"
                             (input)="volumeName = $event.target.value"
                             [ngClass]="{'is-invalid':diskspace > 0 && volumeName == '',
                             'is-valid': diskspace == 0 || (diskspace > 0 && volumeName != '')}">

                    </div>
                  </div>
                </div>
              </div>

              <div
                *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params && selectedProjectVmsUsed < selectedProjectVmsMax"
                class="form-group row">

                <label class="col-md-2 form-control-label">Storage</label>

                <div class="col-md-9">
                  <div class="input-group">
                    <input min="0" step="1" [value]="diskspace"
                           (input)="diskspace = $event.target.value"
                           type="number" [max]="selectedProjectDiskspaceMax - selectedProjectDiskspaceUsed"
                           placeholder="e.g 8 ">
                    <div class="input-group-append"><span
                      class="input-group-text"> GB
                                    </span></div>

                    <div class="col-md-6">
                      <strong> {{selectedProjectDiskspaceMax - selectedProjectDiskspaceUsed}} GB available
                      </strong>
                    </div>

                  </div>
                </div>


              </div>
              <div
                *ngIf="selectedProject && selectedProject[1] != FREEMIUM_ID && optional_params && selectedProjectVmsUsed < selectedProjectVmsMax"
                class="form-group row">

                <label class="col-md-2 form-control-label">Open Ports</label>
                <div class="col-md-2">
                  <label
                    class="switch switch-label switch-pill switch-success">Udp
                    <input type="checkbox" class="switch-input"
                           name="udp_allowed"
                           [(ngModel)]="udp_allowed"
                    >
                    <span class="switch-slider" data-checked="✓" data-unchecked="✕"></span>
                    <!--<span class="switch-handle"></span>-->
                  </label></div>


              </div>
              <div
                *ngIf="selectedProject && projectDataLoaded && is_vo && selectedProjectVmsUsed < selectedProjectVmsMax"
                class="form-group row">


                <label class="col-md-3 form-control-label"><strong>Bioconda </strong><span class="badge badge-primary">BETA</span></label>
                <div class="col-md-6">
                  <button type="button" class="btn btn-info .btn-pill"
                          (click)="bioconda_show = !bioconda_show">
                    <strong *ngIf="!bioconda_show">Show</strong><strong
                    *ngIf="bioconda_show">Hide</strong>
                  </button>
                </div>
              </div>
              <div *ngIf="bioconda_show" class="col-12">
                <app-bioconda #bioconda></app-bioconda>
              </div>
            </div>
          </form>

        </div>


        <div class="form-group row"
             *ngIf="projectDataLoaded && selectedProjectVmsUsed < selectedProjectVmsMax && flavors?.length > 0 ">

          <button style=" margin-left: auto;margin-top: 25px;
    margin-right: auto;
    width: 8em"

                  type="button"
                  [disabled]="f.invalid || (diskspace > 0 && volumeName == '')"
                  class="btn btn-primary  .btn-lg offset-md-8"
                  data-toggle="modal"
                  (click)="startVM(selectedFlavor.name,selectedImage.name,f.controls.instance_name.value,selectedProject[0],selectedProject[1]);resetData();resetProgressBar;infoModal.show();">
            Start VM
          </button>
        </div>


        <div class="alert alert-danger"
             *ngIf="isLoaded && !client_avaiable && selectedProject && client_checked">The
          corresponding client is currently offline.
          If you have any questions please contact cloud@denbi.de.
        </div>


      </div>

      <!--/.col-->

    </div>
  </div>
  <div class="col-md-6">

  </div>

</div>


<div bsModal #infoModal="bs-modal" class="modal fade " tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-info" role="document"
       [ngClass]="newVm?.status =='ACTIVE' ? 'modal-lg':''">

    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" *ngIf="newVm?.status != 'ACTIVE'">Status</h4>
        <h4 class="modal-title" *ngIf="newVm?.status == 'ACTIVE'">How to Connect</h4>

        <button type="button" class="close" style="cursor: pointer"
                (click)="infoModal.hide()"
                aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body"
           *ngIf="(newVm?.status == 'BUILD' || newVm?.status == 'PORT_CLOSED' || newVm ==null) && !create_error?.error ">
        <p>We are setting up a machine for you. This can take up to 5 minutes.</p>

        <div class="progress">
          <div class="progress-bar progress-bar-striped {{creating_vm_prograss_bar}} bg-info"
               role="progressbar" style="width: 33%;"
               aria-valuemin="0"
               aria-valuemax="100">{{creating_vm_status}}
          </div>

          <div class="progress-bar progress-bar-striped {{checking_vm_status_progress_bar}}"
               [style.width.%]="checking_vm_status_width"
               role="progressbar"
               aria-valuemin="0"
               aria-valuemax="100">{{checking_vm_status}}
          </div>

          <div
            class="progress-bar progress-bar-striped bg-success progress-bar-animated "
            role="progressbar"
            [style.width.%]="checking_vm_ssh_port_width"

            aria-valuemin="0"
            aria-valuemax="100">{{checking_vm_ssh_port}}
          </div>
        </div>
        <p>If you close this modal you can find instructions how to connect to the virtual
          machine on the
          instance overview site</p>
      </div>
      <div class="modal-body" *ngIf="newVm?.status == 'ACTIVE'">
        <app-how-to-connect [selectedVm]="newVm"></app-how-to-connect>
      </div>
      <div class="modal-body" *ngIf="create_error?.error">
        An Error occured.<br><br>
        <pre><code>{{create_error.error}}</code></pre>
      </div>
      <div class="modal-footer">
        <button *ngIf="newVm?.status == 'ACTIVE'"
                routerLinkActive="active"
                [routerLink]="['/virtualmachines/vmOverview']"
                type="button" class="btn btn-info nav-link"
                (click)="infoModal.hide();resetData()">Instance Overview
        </button>
        <button type="button" class="btn btn-secondary"
                (click)="infoModal.hide();resetData()">Close
        </button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


