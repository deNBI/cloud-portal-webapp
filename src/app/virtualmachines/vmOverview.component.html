<div *ngIf="isLoaded==false" class="loader"></div>

<div *ngIf="isLoaded" class="card">

    <div class="card-header">
        <strong>Instance</strong>
        â€“Overview
    </div>
    <div *ngIf="is_vo_admin">


        <button style="margin-right: 5px;margin-left: 5px;margin-top:5px;margin-bottom: 5px" class="btn btn-primary"
                (click)="getVms(elixir_id);toggleTab('own');">Own Machines
        </button>

        <button style="margin-right: 5px;margin-left: 5px;margin-top: 5px;margin-bottom: 5px" class="btn btn-primary"
                (click)="getAllVms();toggleTab('all')">All Machines
        </button>


    </div>


    <div class="table-responsive">
        <pagination [totalItems]="vms_filtered?.length" [itemsPerPage]="vmsPerPage"
                    (pageChanged)="pageChanged($event)" [(ngModel)]="currentPage"></pagination>

        <table class="table table-striped col-md-12">
            <thead>
            <tr>
                <th>Name</th>
                <th>Project</th>
                <th>Status</th>
                <th>Created at (d/m/y)</th>
                <th>How to Connect</th>
                <th *ngIf="is_vo_admin">Elixir ID</th>
                <th>Stopped at (d/m/y)</th>
                <th>Actions</th>


            </tr>

            </thead>
            <tbody>
            <td><input style="width: 110px;" type="text" placeholder="Filter" name="filtername"
                       [(ngModel)]="filtername" (ngModelChange)="applyFilter();"></td>
            <td><input style="width: 110px;" t type="text" placeholder="Filter" name="filterproject"
                       [(ngModel)]="filterproject" (ngModelChange)="applyFilter();"></td>
            <td>

                <div class="checkbox">
                    <label>
                        <input type="checkbox"
                               (change)="changeFilterStatus('ACTIVE');applyFilter();" checked/>
                        <span style="margin-left: 5px"
                              class="badge badge-success">ACTIVE </span>

                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox"
                               (change)="changeFilterStatus('SUSPENDED');applyFilter();" checked/>
                        <span style="margin-left: 5px"
                              class="badge badge-warning">SUSPENDED </span>
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox"
                               (change)="changeFilterStatus('DELETED');applyFilter();"/>
                        <span style="margin-left: 5px"
                              class="badge badge-danger">DELETED </span>
                    </label>
                </div>
            </td>
            <td><input style="width: 110px;" t type="text" placeholder="Filter" name="filtercreated_at"
                       [(ngModel)]="filtercreated_at" (ngModelChange)="applyFilter();"></td>
            <td></td>
            <td *ngIf="is_vo_admin"><input style="width: 110px;" t type="text" placeholder="Filter"
                                           name="filterelixir_id" [(ngModel)]="filterelixir_id"
                                           (ngModelChange)="applyFilter();"></td>
            <td><input style="width: 110px;" t type="text" placeholder="Filter" name="filterstopped_at"
                       [(ngModel)]="filterstopped_at" (ngModelChange)="applyFilter();"></td>


            <ng-container *ngFor="let vm of vms_returned">


                <tr>
                    <td>
                        {{vm.name}}
                    </td>
                    <td style="word-wrap: break-word;min-width: 110px; max-width: 110px; white-space: normal">
                        {{vm.project}}
                    </td>
                    <td style="word-wrap: break-word;min-width: 110px; max-width: 110px; white-space: normal">
                         <span *ngIf="vm.status == 'DELETED'" style="margin-left: 5px"
                               class="badge badge-danger"> {{vm.status}}</span>
                        <span *ngIf="vm.status == 'ACTIVE'" style="margin-left: 5px"
                              class="badge badge-success"> {{vm.status}}</span>
                        <span *ngIf="vm.status == 'SUSPENDED'" style="margin-left: 5px"
                              class="badge badge-warning"> {{vm.status}}</span>
                        <span class="badge badge-info"
                              *ngIf="vm.status != 'DELETED' && vm.status != 'ACTIVE' && vm.status != 'SUSPENDED'">{{vm.status}}</span>
                    </td>
                    <td style="word-wrap: break-word;min-width: 110px; max-width: 110px; white-space: normal">
                        {{vm.created_at}}
                    </td>
                    <td style="word-wrap: break-word;min-width: 110px; max-width: 110px; white-space: normal">
                        <button type="button" class="btn btn-secondary btn-block"
                                style="white-space: normal; word-wrap: break-word;"
                                (click)="selected_command=vm.ssh_command;infoModal.show()"> Show Information
                        </button>
                    </td>
                    <td *ngIf="is_vo_admin"
                        style="word-wrap: break-word;min-width: 110px; max-width: 110px; white-space: normal">
                        {{vm.elixir_id}}
                    </td>
                    <td>
                        {{vm.stopped_at}}
                    </td>

                    <td>
                        <div *ngIf="vm.status !='DELETED'"
                             class="btn-group {{collapse_status[vm.openstackid]}}">

                            <button class="btn btn-secondary" type="button" *ngIf="vm.status !='DELETED'"
                                    (click)="snapshot_vm=vm;resetSnapshotResult();snapshotModal.show();">

                                Create Snapshot
                            </button>
                            <button class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
                                    data-toggle="dropdown"
                                    type="button" aria-haspopup="true" aria-expanded="false"
                                    (click)="getCollapseStatus(vm.openstackid)"></button>
                            <ul class="dropdown-menu " role="menu">
                                <li role="menuitem" *ngIf="vm.status =='ACTIVE'">
                                    <a class="dropdown-item"
                                       (click)="status_changed_vm=vm.name;stopVm(vm.openstackid,vm.name);stopModal.show();">Stop
                                        Vm</a>
                                </li>

                                <li *ngIf="vm.status =='SUSPENDED'" role="menuitem">
                                    <a class="dropdown-item"
                                       (click)="status_changed_vm=vm.name;resumeVM(vm.openstackid);resumeModal.show();">Resume
                                        Vm</a>
                                </li>
                                <li *ngIf="vm.status !='SUSPENDED' && vm.status != 'ACTIVE' && vm.status != 'DELETED' && vm.status != 'FREEMIUM'"
                                    role="menuitem">
                                    <a class="dropdown-item"
                                       (click)="checkStatus(vm.openstackid);">Check Status
                                    </a>
                                </li>
                                <li *ngIf="vm.status !='DELETED'" role="menuitem">
                                    <a class="dropdown-item"
                                       (click)="status_changed_vm=vm.name;status_changed_vm_id=vm.openstackid;verifyModal.show();">Delete
                                        Vm</a>
                                </li>
                            </ul>
                        </div>


                    </td>
                </tr>
            </ng-container>
            </tbody>
        </table>
    </div>
</div>


<div bsModal #stopModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Label"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" *ngIf="status_changed == 0"> Waiting </h4>
                <h4 class="modal-title" *ngIf="status_changed == 1"> Success </h4>
                <h4 class="modal-title" *ngIf="status_changed == 2"> Error </h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert" *ngIf="status_changed == 0">
                    Stopping {{status_changed_vm}}... <i class="fa fa-spinner fa-spin" style="font-size:24px"></i>
                </div>
                <div class="alert alert-success" role="alert" *ngIf="status_changed == 1">
                    {{status_changed_vm}} was succesfully stopped.
                </div>
            </div>
            <div class="alert alert-warning" role="alert" *ngIf="status_changed == 2">
                When stopping {{status_changed_vm}} an error occured.
            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="status_changed=0;stopModal.hide()">Close
                </button>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div bsModal #resumeModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Label"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" *ngIf="status_changed == 0"> Waiting </h4>
                <h4 class="modal-title" *ngIf="status_changed == 1"> Success </h4>
                <h4 class="modal-title" *ngIf="status_changed == 2"> Error </h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert" *ngIf="status_changed == 0">
                    Resuming {{status_changed_vm}}... <i class="fa fa-spinner fa-spin" style="font-size:24px"></i>
                </div>
                <div class="alert alert-success" role="alert" *ngIf="status_changed == 1">
                    {{status_changed_vm}} was succesfully resumed.
                </div>
            </div>
            <div class="alert alert-warning" role="alert" *ngIf="status_changed == 2">
                When resuming {{status_changed_vm}} an error occured.
            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="status_changed=0;resumeModal.hide()">Close
                </button>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div bsModal #deleteModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Label"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" *ngIf="status_changed == 0"> Waiting </h4>
                <h4 class="modal-title" *ngIf="status_changed == 1"> Success </h4>
                <h4 class="modal-title" *ngIf="status_changed == 2"> Error </h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert" *ngIf="status_changed == 0">
                    Deleting {{status_changed_vm}}... <i class="fa fa-spinner fa-spin" style="font-size:24px"></i>
                </div>
                <div class="alert alert-success" role="alert" *ngIf="status_changed == 1">
                    {{status_changed_vm}} was succesfully deleted.
                </div>
            </div>
            <div class="alert alert-warning" role="alert" *ngIf="status_changed == 2">
                When deleting {{status_changed_vm}} an error occured.
            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="status_changed=0;deleteModal.hide()">Close
                </button>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div bsModal #verifyModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Label"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete Vm</h4>
                <button type="button" class="close" (click)="verifyModal.hide()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="alert alert-warning" role="alert">
                    Are you sure you want to delete {{status_changed_vm}}?
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn  btn-success col-md-4"
                        (click)="deleteVm(status_changed_vm_id);verifyModal.hide();deleteModal.show()">
                    Yes
                </button>
                <button class="btn  btn-danger col-md-4" type="reset"
                        (click)="status_changed_vm_id='';verifyModal.hide();">Cancel
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div bsModal #snapshotModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Label"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Create Snapshot</h4>
                <button type="button" class="close" (click)="snapshotModal.hide()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div><strong>Snapshot Name*</strong></div>

                <div class="input-group">
                    <input type="text" placeholder="Snapshot Name" [(ngModel)]="snapshotName"
                           (ngModelChange)="validSnapshotName($event);">
                </div>
                <br>
                <div class="alert alert-info" role="alert">
                    A snapshot is an image which preserves the disk state of a running instance.
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn  btn-success col-md-4"
                        [disabled]="!validSnapshotNameBool"
                        (click)="createSnapshot(snapshot_vm.openstackid,snapshotName);snapshotModal.hide();snapshotResult.show()">
                    Create Snapshot
                </button>
                <button class="btn  btn-danger col-md-4" type="reset"
                        (click)="snapshotName=''; validSnapshotNameBool=false;snapshotModal.hide()">Cancel
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div bsModal #snapshotResult="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Label"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Snapshot</h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert" *ngIf="snapshotDone == 'Waiting' ">
                    Wait until Snapshot is created....
                </div>


                <div class="alert alert-success" role="alert" *ngIf="snapshotDone == 'true' ">
                    Successfully created Snapshot.
                    It might take some minutes till you can use it for starting a new instance.
                </div>
                <div class="alert alert-danger" role="alert"
                     *ngIf="snapshotDone != 'true' && snapshotDone != 'Waiting'">
                    An error occured when creating the snapshot.

                    <pre>{{snapshotDone}}</pre>
                </div>


            </div>
            <div class="modal-footer">
                <button class="btn  btn-danger col-md-4" type="reset"
                        (click)="snapshotName=''; validSnapshotNameBool=false;snapshotResult.hide();">Close
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div bsModal #infoModal="bs-modal" class="modal fade" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-info" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">How to connect</h4>
                <button type="button" class="close" (click)="infoModal.hide()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>


            <div class="modal-body">
                <pre><code>{{selected_command}}</code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="infoModal.hide();">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
