<div *ngIf="!isLoaded" class="loader" data-test-id="site-loader"></div>
<div *ngIf="isLoaded" class="animated fadeIn">
    <div class="card" *ngIf="is_vo_admin">
        <div class="card-header"><i class="fa fa-align-justify"></i> Applications for review</div>

        <div class="btn-group" role="group">
            <button
                    class="btn"
                    (click)="changeTabState(ApplicationTabStates.SUBMITTED)"
                    [ngClass]="{
					'btn-light': !(tab_state === ApplicationTabStates.SUBMITTED),
					'btn-primary': tab_state === ApplicationTabStates.SUBMITTED
				}"
                    id="tab_state_button_submitted_applications"
                    data-test-id="submitted_applications_tab"
            >
                <i class="fas fa-envelope"></i> Submitted Applications
                <span class="badge badge-pill bg-dark">{{ numberOfProjectApplications }}</span>
            </button>
            <button
                    class="btn"
                    (click)="changeTabState(ApplicationTabStates.CREDITS_EXTENSION)"
                    [ngClass]="{
					'btn-light': !(tab_state === ApplicationTabStates.CREDITS_EXTENSION),
					'btn-primary': tab_state === ApplicationTabStates.CREDITS_EXTENSION
				}"
                    id="tab_state_button_credit_request"
                    data-test-id="credit_requests_applications_tab"
            >
                <i class="fas fa-coins"></i> Credit Extension Requests
                <span class="badge badge-pill bg-dark">{{ numberOfCreditRequests }}</span>
            </button>
            <button
                    class="btn"
                    (click)="changeTabState(ApplicationTabStates.LIFETIME_EXTENSION)"
                    [ngClass]="{
					'btn-light': !(tab_state === ApplicationTabStates.LIFETIME_EXTENSION),
					'btn-primary': tab_state === ApplicationTabStates.LIFETIME_EXTENSION
				}"
                    id="tab_state_button_extension_request"
                    data-test-id="extension_requests_applications_tab"
            >
                <i class="fas fa-clock"></i> Lifetime Extension Requests
                <span class="badge badge-pill bg-dark">{{ numberOfExtensionRequests }}</span>
            </button>
            <button
                    class="btn"
                    (click)="changeTabState(ApplicationTabStates.MODIFICATION_EXTENSION)"
                    [ngClass]="{
					'btn-light': !(tab_state === ApplicationTabStates.MODIFICATION_EXTENSION),
					'btn-primary': tab_state === ApplicationTabStates.MODIFICATION_EXTENSION
				}"
                    id="tab_state_button_modification_request"
                    data-test-id="modification_requests_applications_tab"
            >
                <i class="fas fa-memory"></i> Resource Modification Requests
                <span class="badge badge-pill bg-dark">{{ numberOfModificationRequests }}</span>
            </button>
        </div>
        <div class="card-body" *ngIf="loading_applications" id="loading_applications"
             data-test-id="loading_applications">
            <div class="alert alert-success">
                <strong>Loading applications/requests ...</strong>
            </div>
        </div>
        <ng-container>
            @if (all_applications.length <= 0 && !loading_applications) {
                <div
                        class="card-body"
                        data-test-id="submitted_applications_container"
                >
                    <div class="alert alert-success" role="alert">
                        <strong>No new Applications!</strong> There is nothing to review.
                    </div>
                </div>
            } @else {
                <app-application-list (reloadNumbersTrigger)="getApplicationNumbers()" [applications]="all_applications"
                                      [computeCenters]="computeCenters"
                                      [tabState]="tab_state"></app-application-list>
            }

        </ng-container>
        <ng-container [ngSwitch]="tab_state">

            <ng-container *ngSwitchCase="ApplicationTabStates.MODIFICATION_EXTENSION">
                <div class="card-body" *ngIf="all_applications.length <= 0 && !loading_applications">
                    <div class="alert alert-success" role="alert"
                         data-test-id="modification_requests_applications_container">
                        <strong>No new Resource Modification Requests!</strong>
                    </div>
                </div>

                <div
                        *ngIf="all_applications.length > 0"
                        class="card-body"
                        data-test-id="modification_requests_applications_container"
                >
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th></th>
                                <th>Project Name</th>
                                <th>Short Name</th>
                                <th>Modification submitted</th>
                                <th>User</th>
                                <th>Institute</th>
                                <th>Compute Center</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <ng-container *ngFor="let application of all_applications">
                                <ng-container>
                                    <tr>
                                        <td>
                                            <app-application-badges
                                                    [application]="application"></app-application-badges>
                                        </td>
                                        <td>{{ application?.project_application_name }}</td>
                                        <td>{{ application?.project_application_shortname }}</td>
                                        <td>{{ application?.project_modification_request?.date_submitted }}</td>
                                        <td style="word-wrap: break-word; min-width: 110px; max-width: 130px; white-space: normal">
                                            @if (application?.project_application_user?.username) {
                                                {{ application?.project_application_user?.username }}
                                            } @else {
                                                <span class="spinner-border text-info"></span>

                                            }

                                        </td>
                                        <td>{{ application?.project_application_institute }}</td>

                                        <td>
                                            <span>{{ application?.project_application_compute_center?.Name }}</span>
                                        </td>

                                        <td>
                                            <div class="btn-group">
                                                <button
                                                        *ngIf="application?.processing_vo_initials"
                                                        style="margin: 2px"
                                                        (click)="unsetProcessingVoManager(application)"
                                                        type="button"
                                                        class="btn btn-danger"
                                                        title="Unassign Processing VO"
                                                >
                                                    <i class="fa fa-user-slash"></i>&nbsp; <span class="d-none">Unassign Proccessing VO</span>
                                                </button>
                                                <button
                                                        *ngIf="!application?.processing_vo_initials"
                                                        style="margin: 2px"
                                                        (click)="setCurrentUserProcessingVoManager(application)"
                                                        type="button"
                                                        class="btn btn-secondary"
                                                >
                                                    <i class="fa fa-user-pen"></i>&nbsp;
                                                    <span class="d-none">Assign Proccessing VO</span>
                                                </button>
                                                <button
                                                        [id]="'modification_adjustment_' + application?.project_application_shortname"
                                                        [attr.data-test-id]="
															'modification_adjustment_' + application?.project_application_shortname
														"
                                                        *ngIf="
															(application | hasstatusinlist: Application_States.MODIFICATION_REQUESTED) &&
															application?.project_modification_request
														"
                                                        style="margin: 2px"
                                                        type="button"
                                                        (click)="setApplicationToAdjust(application); showModificationAdjustmentModal()"
                                                        class="btn btn-primary"
                                                >
                                                    <i class="fa fa-pen"></i>&nbsp;
                                                    <span class="d-none"> Adjust Modification</span>
                                                </button>

                                                <button
                                                        [id]="'modification_approval_' + application?.project_application_shortname"
                                                        *ngIf="
															(application | hasstatusinlist: Application_States.MODIFICATION_REQUESTED) &&
															application?.project_application_openstack_project &&
															application?.project_modification_request
														"
                                                        style="margin: 2px"
                                                        [attr.data-test-id]="'modification_approval_' + application?.project_application_shortname"
                                                        (click)="showConfirmationModal(application, ConfirmationActions.APPROVE_MODIFICATION)"
                                                        type="button"
                                                        class="btn btn-success"
                                                >
                                                    <i class="fa fa-check"></i>&nbsp;
                                                    <span class="d-none">Approve Modification</span>
                                                </button>

                                                <button
                                                        [id]="'modification_approval_' + application?.project_application_shortname"
                                                        *ngIf="
															(application | hasstatusinlist: Application_States.MODIFICATION_REQUESTED) &&
															!application?.project_application_openstack_project &&
															application?.project_modification_request
														"
                                                        style="margin: 2px"
                                                        [attr.data-test-id]="'modification_approval_' + application?.project_application_shortname"
                                                        (click)="
															showClientsLimitsModal(
																application.project_application_compute_center.FacilityId,
																application,
																true
															)
														"
                                                        type="button"
                                                        class="btn btn-success"
                                                >
                                                    <i class="fa fa-check"></i>&nbsp;
                                                    <span class="d-none">Approve Modification</span>
                                                </button>
                                                <button
                                                        *ngIf="
															(application | hasstatusinlist: Application_States.MODIFICATION_REQUESTED) &&
															application?.project_modification_request
														"
                                                        type="button"
                                                        class="btn btn-danger"
                                                        style="margin: 2px"
                                                        (click)="showConfirmationModal(application, ConfirmationActions.DECLINE_MODIFICATION)"
                                                >
                                                    <i class="fa fa-times"></i>&nbsp;
                                                    <span class="d-none">Decline Modification</span>
                                                </button>

                                                <button
                                                        (click)="
															switchCollapseStatus('application_review-' + application?.project_application_id);
															getMemberDetailsByElixirIdIfCollapsed(
																application,
																'application_review-' + application?.project_application_id
															)
														"
                                                        type="button"
                                                        class="btn btn-secondary"
                                                        style="margin: 2px"
                                                >
                                                    <i class="fa fa-info-circle"></i>&nbsp;
                                                    <span
                                                            class="d-none"
                                                            [hidden]="!getCollapseStatus('application_review-' + application?.project_application_id)"
                                                    >Show</span
                                                    >
                                                    <span
                                                            class="d-none"
                                                            [hidden]="getCollapseStatus('application_review-' + application?.project_application_id)"
                                                    >Hide</span
                                                    >
                                                    <span class="d-none"> Information</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                    <td colspan="12">
                                        <ng-container
                                                *ngIf="!getCollapseStatus('application_review-' + application?.project_application_id)">
                                            <app-application-detail
                                                    [default_tab]="tab_state"
                                                    [class.collapse_no_margin]="getCollapseStatus('application_review-' + application?.project_application_id)"
                                                    [class.collapse]="getCollapseStatus('application_review-' + application?.project_application_id)"
                                                    [application]="application"
                                            ></app-application-detail>
                                        </ng-container>
                                    </td>

                                </ng-container>
                            </ng-container>
                            </tbody>
                        </table>
                    </div>
                </div>
            </ng-container>
            <ng-container *ngSwitchCase="ApplicationTabStates.CREDITS_EXTENSION"
                          data-test-id="credit_requests_applications_container">
                <div class="card-body" *ngIf="all_applications.length <= 0 && !loading_applications">
                    <div class="alert alert-success" role="alert">
                        <strong>No new Credit Requests!</strong>
                    </div>
                </div>

                <div *ngIf="all_applications.length > 0" class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th></th>
                                <th>Project Name</th>
                                <th>Short Name</th>
                                <th>Credits request submitted</th>
                                <th>User</th>
                                <th>Institute</th>
                                <th>Compute Center</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <ng-container *ngFor="let application of all_applications">
                                <ng-container>
                                    <tr>
                                        <td>
												<span
                                                        *ngIf="application?.project_application_openstack_project"
                                                        style="font-size: 20px"
                                                        class="project-openstack_plain_white_redbg"
                                                        data-toggle="tooltip"
                                                        title="Thisadjust is an Openstack project"
                                                >
													<span class="path1"></span>
													<span class="path2"></span>
												</span>
                                            <span
                                                    style="margin-left: 12px"
                                                    class="badge badge-info"
                                                    data-toggle="tooltip"
                                                    data-placement="auto"
                                                    title="Initials of processing vo manager: {{ application?.processing_vo_initials }}"
                                                    *ngIf="application?.processing_vo_initials && is_vo_admin"
                                            ><span style="font-size: 17px"> {{ application?.processing_vo_initials }}</span>
												</span>
                                            <span
                                                    *ngIf="!application?.project_application_openstack_project"
                                                    style="font-size: 20px"
                                                    class="project-simpleVM_Logo_bluebg"
                                                    data-toggle="tooltip"
                                                    title="This is a Simple VM project"
                                            >
													<span class="path1"></span>
													<span class="path2"></span>
													<span class="path3"></span>
													<span class="path4"></span>
													<span class="path5"></span>
												</span>
                                            <span
                                                    *ngIf="application?.project_application_pi_approved"
                                                    style="margin: 2px"
                                                    class="badge"
                                                    data-toggle="tooltip"
                                                    data-placement="auto"
                                                    title="This application was approved by a PI"
                                            >
													<span class="icon icon-yes_pi" style="font-size: 20px">
														<span class="path1"></span><span class="path2"></span><span
                                                            class="path3"></span
                                                    ><span class="path4"></span>
													</span>
												</span>
                                            <span
                                                    *ngIf="!application?.project_application_pi_approved"
                                                    style="margin: 2px"
                                                    class="badge"
                                                    data-toggle="tooltip"
                                                    data-placement="auto"
                                                    title="This application is yet not approved by a PI"
                                            >
													<span class="icon icon-no_pi" style="font-size: 2em">
														<span class="path1"></span><span class="path2"></span><span
                                                            class="path3"></span
                                                    ><span class="path4"></span>
													</span>
												</span>
                                            <span
                                                    style="margin-left: 12px"
                                                    class="badge badge-info"
                                                    data-toggle="tooltip"
                                                    data-placement="auto"
                                                    title="Initials of processing vo manager: {{ application?.processing_vo_initials }}"
                                                    *ngIf="application?.processing_vo_initials && is_vo_admin"
                                            ><span style="font-size: 17px"> {{ application?.processing_vo_initials }}</span>
												</span>
                                        </td>
                                        <td>{{ application?.project_application_name }}</td>
                                        <td>{{ application?.project_application_shortname }}</td>
                                        <td>{{ application?.project_credit_request?.date_submitted }}</td>
                                        <td style="word-wrap: break-word; min-width: 110px; max-width: 130px; white-space: normal">
                                            {{ application?.project_application_user?.username }}
                                        </td>
                                        <td>{{ application?.project_application_institute }}</td>

                                        <td>
												<span *ngIf="application?.project_application_compute_center">{{
                                                        application?.project_application_compute_center?.Name
                                                    }}</span>
                                        </td>

                                        <td>
                                            <div class="btn-group">
                                                <button
                                                        *ngIf="application?.processing_vo_initials"
                                                        style="margin: 2px"
                                                        (click)="unsetProcessingVoManager(application)"
                                                        type="button"
                                                        class="btn btn-danger"
                                                        title="Unassign Processing VO"
                                                >
                                                    <i class="fa fa-user-slash"></i>&nbsp; <span class="d-none">Unassign Proccessing VO</span>
                                                </button>
                                                <button
                                                        *ngIf="!application?.processing_vo_initials"
                                                        style="margin: 2px"
                                                        (click)="setCurrentUserProcessingVoManager(application)"
                                                        type="button"
                                                        class="btn btn-secondary"
                                                >
                                                    <i class="fa fa-user-pen"></i>&nbsp;
                                                    <span class="d-none">Assign Proccessing VO</span>
                                                </button>
                                                <button
                                                        [id]="'credit_extension_approval_' + application?.project_application_shortname"
                                                        *ngIf="application | hasstatusinlist: Application_States.CREDITS_EXTENSION_REQUESTED"
                                                        style="margin: 2px"
                                                        (click)="showConfirmationModal(application, ConfirmationActions.APPROVE_CREDITS)"
                                                        type="button"
                                                        class="btn btn-success"
                                                >
                                                    <i class="fa fa-check"></i>&nbsp;
                                                    <span class="d-none">Approve Credits</span>
                                                </button>

                                                <button
                                                        [id]="'credit_extension_decline_' + application?.project_application_shortname"
                                                        *ngIf="application | hasstatusinlist: Application_States.CREDITS_EXTENSION_REQUESTED"
                                                        (click)="showConfirmationModal(application, ConfirmationActions.DECLINE_CREDITS)"
                                                        type="button"
                                                        class="btn btn-danger"
                                                        style="margin: 2px"
                                                >
                                                    <i class="fas fa-times"></i>&nbsp;
                                                    <span class="d-none">Decline Credits</span>
                                                </button>

                                                <button
                                                        (click)="
															switchCollapseStatus('application_review-' + application?.project_application_id);
															getMemberDetailsByElixirIdIfCollapsed(
																application,
																'application_review-' + application?.project_application_id
															)
														"
                                                        type="button"
                                                        class="btn btn-secondary"
                                                        style="margin: 2px"
                                                >
                                                    <i class="fa fa-info-circle"></i>&nbsp;
                                                    <span
                                                            class="d-none"
                                                            [hidden]="!getCollapseStatus('application_review-' + application?.project_application_id)"
                                                    >Show</span
                                                    >
                                                    <span
                                                            class="d-none"
                                                            [hidden]="getCollapseStatus('application_review-' + application?.project_application_id)"
                                                    >Hide</span
                                                    >
                                                    <span class="d-none"> Information</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                    <td colspan="12">
                                        <ng-container
                                                *ngIf="!getCollapseStatus('application_review-' + application?.project_application_id)">

                                            <app-application-detail
                                                    [default_tab]="tab_state"
                                                    [class.collapse_no_margin]="
													getCollapseStatus('application_review-' + application?.project_application_id)
												"
                                                    [class.collapse]="
													getCollapseStatus('application_review-' + application?.project_application_id)
												"
                                                    [application]="application"
                                            ></app-application-detail>
                                        </ng-container>
                                    </td>
                                </ng-container>
                            </ng-container>
                            </tbody>
                        </table>
                    </div>
                </div>
            </ng-container>
        </ng-container>
    </div>

    <div class="card" *ngIf="is_vo_admin && false">
        <div class="card-header"><i class="fa fa-align-justify"></i> Applications history</div>
        <div class="card-body" *ngIf="applications_history?.length === 0">
            <div class="alert alert-success" role="alert">
                <strong>No submitted Applications</strong> There are no applications at all.
            </div>
        </div>
        <div *ngIf="applications_history.length > 0" class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th></th>
                        <th>Project Name</th>
                        <th>Short Name</th>
                        <th>Date submitted (d/m/y)</th>
                        <th>Institute</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <ng-container *ngFor="let application of applications_history">
                        <ng-container *ngIf="application?.project_application_date_submitted">
                            <tr>
                                <td>
                                    <app-application-badges [application]="application"></app-application-badges>
                                </td>
                                <td>{{ application?.project_application_name }}</td>
                                <td>{{ application?.project_application_shortname }}</td>
                                <td>{{ application?.project_application_date_submitted }}</td>
                                <td>{{ application?.project_application_institute }}</td>
                                <td>
                                    <span *ngFor="let st of application?.project_application_statuses">{{ getStatusById(st) }}</span>
                                </td>
                                <td>
                                    <button
                                            (click)="
												getApplication(application);
												switchCollapseStatus('application_history-' + application?.project_application_id)
											"
                                            type="button"
                                            class="btn btn-secondary"
                                    >
                                        <i class="fa fa-info-circle"></i>&nbsp;
                                        <span [hidden]="!getCollapseStatus('application_history-' + application?.project_application_id)"
                                        >Show</span
                                        ><span
                                            [hidden]="getCollapseStatus('application_history-' + application?.project_application_id)"
                                            style="margin-left: 5px"
                                    >Hide</span
                                    >
                                        Information
                                    </button>
                                </td>
                            </tr>
                            <td colspan="12">
                                <ng-container
                                        *ngIf="!getCollapseStatus('application_history-' + application?.project_application_id)">

                                    <app-application-detail
                                            *ngIf="!getCollapseStatus('application_history-' + application?.project_application_id)"
                                            [default_tab]="tab_state"
                                            [class.collapse_no_margin]="
											getCollapseStatus('application_history-' + application?.project_application_id)
										"
                                            [class.collapse]="getCollapseStatus('application_history-' + application?.project_application_id)"
                                            [application]="application"
                                    ></app-application-detail>
                                </ng-container>
                            </td>
                        </ng-container>
                    </ng-container>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div
        bsModal
        #resultModal="bs-modal"
        class="modal fade"
        tabindex="-1"
        role="dialog"
        aria-labelledby="Label"
        aria-hidden="true"
>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" *ngIf="extension_status === 0">Waiting</h4>
                <h4 class="modal-title" *ngIf="extension_status === 1">Success</h4>
                <h4 class="modal-title" *ngIf="extension_status === 2">Error</h4>
                <button
                        type="button"
                        class="btn-close"
                        style="cursor: pointer"
                        (click)="resultModal.hide(); extension_status = 0; removeModalOpen()"
                        aria-label="Close"
                ></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-primary" role="alert" *ngIf="extension_status === 0" id="extension_result">
                    Waiting... <i class="fa fa-spinner fa-spin" style="font-size: 24px"></i>
                </div>

                <div class="alert alert-success" role="alert" *ngIf="extension_status === 1" id="extension_result">
                    Modify request successfully submitted!
                </div>
                <div class="alert alert-success" role="alert" *ngIf="extension_status === 3" id="extension_result">
                    Modify request successfully approved!
                </div>
                <div class="alert alert-success" role="alert" *ngIf="extension_status === 4" id="extension_result">
                    Modify request successfully declined!
                </div>
                <div class="alert alert-success" role="alert" *ngIf="extension_status === 5" id="extension_result">
                    Modify request successfully approved and forwarded to facility!
                </div>

                <div class="alert alert-warning" role="alert" *ngIf="extension_status === 2" id="extension_result">
                    An error occured.
                </div>

                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            (click)="resultModal.hide(); extension_status = 0; removeModalOpen()"
                    >
                        Close
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
</div>
